<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Advanced Live Platform Testing</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            h1,
            h2 {
                color: #333;
            }
            button {
                margin: 5px;
                padding: 10px;
                cursor: pointer;
            }
            #results {
                background-color: #f0f0f0;
                padding: 10px;
                border-radius: 5px;
                white-space: pre-wrap;
            }
            #log {
                height: 200px;
                overflow-y: auto;
                border: 1px solid #ccc;
                padding: 10px;
                margin-top: 20px;
            }
        </style>
    </head>
    <body>
        <h1>Advanced Live Platform Testing</h1>

        <h2>User Management</h2>
        <button onclick="register()">Register User</button>
        <button onclick="login()">Login</button>
        <button onclick="getProfile()">Get Profile</button>
        <button onclick="updateProfile()">Update Profile</button>

        <h2>Session Management</h2>
        <button onclick="createSession()">Create Session</button>
        <button onclick="joinSession()">Join Session</button>
        <button onclick="leaveSession()">Leave Session</button>
        <button onclick="endSession()">End Session</button>
        <button onclick="listSessions()">List Sessions</button>

        <h2>Community Management</h2>
        <button onclick="createCommunity()">Create Community</button>
        <button onclick="getCommunity()">Get Community</button>
        <button onclick="joinCommunity()">Join Community</button>
        <button onclick="leaveCommunity()">Leave Community</button>
        <button onclick="listCommunities()">List Communities</button>

        <h2>WebSocket Test</h2>
        <button onclick="connectWebSocket()">Connect WebSocket</button>
        <button onclick="sendMessage()">Send Message</button>
        <button onclick="disconnectWebSocket()">Disconnect WebSocket</button>

        <h2>Stress Test</h2>
        <button onclick="runStressTest()">Run Stress Test</button>

        <h2>Results</h2>
        <pre id="results"></pre>

        <h2>Log</h2>
        <div id="log"></div>

        <script>
            const API_URL =
                "https://94458d4a-03fc-40fe-9c73-a107faef071c-00-126sm7vflti8p.spock.replit.dev/api";
            let token = "";
            let sessionId = "";
            let communityId = "";
            let ws;

            function showResult(result) {
                document.getElementById("results").textContent = JSON.stringify(
                    result,
                    null,
                    2,
                );
            }

            function log(message) {
                const logElement = document.getElementById("log");
                logElement.innerHTML += `${new Date().toISOString()}: ${message}<br>`;
                logElement.scrollTop = logElement.scrollHeight;
            }

            async function makeRequest(method, endpoint, data = null) {
                try {
                    const config = {
                        method,
                        url: `${API_URL}${endpoint}`,
                        headers: { Authorization: `Bearer ${token}` },
                    };
                    if (data) {
                        config.data = data;
                    }
                    const response = await axios(config);
                    log(
                        `${method.toUpperCase()} ${endpoint} - Success. Response: ${JSON.stringify(response.data)}`,
                    );
                    return response.data;
                } catch (error) {
                    log(
                        `${method.toUpperCase()} ${endpoint} - Error: ${error.message}`,
                    );
                    if (error.response) {
                        log(
                            `Response data: ${JSON.stringify(error.response.data)}`,
                        );
                        log(`Response status: ${error.response.status}`);
                    }
                    throw error;
                }
            }

            async function register() {
                const userData = {
                    username: `testuser_${Date.now()}`,
                    email: `test_${Date.now()}@example.com`,
                    password: "password123",
                    language: "en",
                    country: "US",
                };
                await makeRequest("post", "/users/register", userData);
            }

            async function login() {
                const loginData = {
                    email: "test@example.com",
                    password: "password123",
                };
                const response = await makeRequest(
                    "post",
                    "/users/login",
                    loginData,
                );
                token = response.token;
            }

            async function getProfile() {
                await makeRequest("get", "/users/profile");
            }

            async function updateProfile() {
                const updateData = {
                    username: `updated_user_${Date.now()}`,
                    language: "fr",
                    country: "FR",
                };
                await makeRequest("put", "/users/profile", updateData);
            }

            async function createSession() {
                const sessionData = {
                    session_title: `Test Session ${Date.now()}`,
                    description: "This is a test session",
                    language: "en",
                    is_private: false,
                    is_temporary: true,
                    auto_delete: true,
                };
                try {
                    const response = await makeRequest(
                        "post",
                        "/sessions",
                        sessionData,
                    );
                    log(`Create session response: ${JSON.stringify(response)}`);
                    if (response && response.session_id) {
                        sessionId = response.session_id;
                        log(`Session created with ID: ${sessionId}`);
                    } else {
                        throw new Error(
                            `Failed to get session ID from response: ${JSON.stringify(response)}`,
                        );
                    }
                } catch (error) {
                    log(`Error creating session: ${error.message}`);
                    throw error;
                }
            }

            async function joinSession() {
                if (!sessionId) {
                    throw new Error("No session ID available");
                }
                await makeRequest("post", `/sessions/${sessionId}/join`, {
                    is_anonymous: false,
                });
            }

            async function leaveSession() {
                await makeRequest("post", `/sessions/${sessionId}/leave`);
            }

            async function endSession() {
                await makeRequest("post", `/sessions/${sessionId}/end`);
            }

            async function listSessions() {
                await makeRequest("get", "/sessions");
            }

            async function createCommunity() {
                const communityData = {
                    name: `Test Community ${Date.now()}`,
                    description: "This is a test community",
                };
                const response = await makeRequest(
                    "post",
                    "/communities",
                    communityData,
                );
                communityId = response.community_id;
            }

            async function getCommunity() {
                await makeRequest("get", `/communities/${communityId}`);
            }

            async function joinCommunity() {
                await makeRequest("post", `/communities/${communityId}/join`);
            }

            async function leaveCommunity() {
                await makeRequest("post", `/communities/${communityId}/leave`);
            }

            async function listCommunities() {
                await makeRequest("get", "/communities");
            }

            function connectWebSocket() {
                const wsHost =
                    "94458d4a-03fc-40fe-9c73-a107faef071c-00-126sm7vflti8p.spock.replit.dev:8080";
                ws = new WebSocket(`wss://${wsHost}/ws?token=${token}`);
                ws.onopen = () => log("WebSocket connected");
                ws.onmessage = (event) => log(`Received: ${event.data}`);
                ws.onerror = (error) => log(`WebSocket error: ${error}`);
                ws.onclose = () => log("WebSocket closed");
            }

            function sendMessage() {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const message = {
                        type: "chat",
                        sessionId: sessionId,
                        content: "Hello, WebSocket!",
                    };
                    ws.send(JSON.stringify(message));
                    log("Message sent");
                } else {
                    log("WebSocket not connected");
                }
            }

            function disconnectWebSocket() {
                if (ws) {
                    ws.close();
                    log("WebSocket disconnected");
                }
            }

            async function runStressTest() {
                const iterations = 50;
                const start = Date.now();
                log(`Starting stress test with ${iterations} iterations`);

                for (let i = 0; i < iterations; i++) {
                    try {
                        log(`Starting iteration ${i + 1}`);
                        await register();
                        await login();
                        await createSession();
                        if (sessionId) {
                            await joinSession();
                            await leaveSession();
                            await endSession();
                        } else {
                            log(
                                "Skipping session operations due to missing session ID",
                            );
                        }
                        await createCommunity();
                        await joinCommunity();
                        await leaveCommunity();
                        log(`Iteration ${i + 1} completed`);
                    } catch (error) {
                        log(`Error in iteration ${i + 1}: ${error.message}`);
                    }
                    // Add a delay between iterations to reduce server load
                    await new Promise((resolve) => setTimeout(resolve, 1000));
                }

                const end = Date.now();
                const duration = (end - start) / 1000;
                log(`Stress test completed in ${duration} seconds`);
            }
        </script>
    </body>
</html>
